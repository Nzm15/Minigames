<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Dodgeball Arena</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background: radial-gradient(circle, #0f2027, #203a43, #2c5364);
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #fff;
  }
  canvas {
    background: #111;
    border: 3px solid #ff6ec7;
    border-radius: 15px;
    box-shadow: 0 0 20px #ff6ec7;
  }
  h1 {
    margin: 10px;
    color: #ff6ec7;
  }
  #gameOver {
    display: none;
    text-align: center;
  }
  #restartBtn {
    padding: 10px 20px;
    font-size: 18px;
    margin-top: 10px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background: #ff6ec7;
    color: #fff;
    transition: 0.3s;
  }
  #restartBtn:hover {
    background: #ff2e63;
  }
  /* Joystick styles */
  #joystick {
    position: fixed;
    left: 40px;
    bottom: 40px;
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.08);
    border: 2px solid #ff6ec7;
    border-radius: 50%;
    z-index: 1000;
    touch-action: none;
    user-select: none;
  }
  #stick {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 40px;
    height: 40px;
    background: #ff6ec7;
    border-radius: 50%;
    transform: translate(-50%,-50%);
  }
</style>
</head>
<body>
<h1 id="score">Score: 0</h1>
<canvas id="gameCanvas" width="700" height="500"></canvas>
<div id="gameOver">
  <h1 id="finalScore"></h1>
  <button id="restartBtn">Restart</button>
</div>

<div id="joystick" style="display:none;">
  <div id="stick"></div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const player = { x: 350, y: 250, radius: 20, speed: 5, color: '#00ffcc' };
let balls = [];
let score = 0;
let keys = {};
let frame = 0;
let gameRunning = true;
let level = 0;
const levels = [
  { name: 'Slow', score: 0, speed: [2, 4] },
  { name: 'Medium', score: 200, speed: [3, 5] },
  { name: 'Fast', score: 400, speed: [4, 6] },
  { name: 'Super Fast', score: 800, speed: [5, 7] },
  { name: 'Flash', score: 1600, speed: [6, 8] },
  { name: 'Sharinggan', score: 3200, speed: [7, 10] }
];

document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// Device detection
function isMobileDevice() {
  return /android|iphone|ipad|ipod|mobile|tablet/i.test(navigator.userAgent);
}
let useJoystick = isMobileDevice();

// Joystick state
let joystick = {
  active: false,
  startX: 0,
  startY: 0,
  dx: 0,
  dy: 0,
  radius: 40,
  stickRadius: 20
};

if (useJoystick) {
  // Create joystick HTML
  const joy = document.createElement('div');
  joy.id = 'joystick';
  joy.style.position = 'fixed';
  joy.style.left = '40px';
  joy.style.bottom = '40px';
  joy.style.width = joystick.radius * 2 + 'px';
  joy.style.height = joystick.radius * 2 + 'px';
  joy.style.background = 'rgba(255,255,255,0.08)';
  joy.style.border = '2px solid #ff6ec7';
  joy.style.borderRadius = '50%';
  joy.style.zIndex = 1000;
  joy.style.touchAction = 'none';
  joy.style.userSelect = 'none';
  joy.style.display = 'block';
  joy.innerHTML = '<div id="stick" style="position:absolute;left:50%;top:50%;width:' + (joystick.stickRadius*2) + 'px;height:' + (joystick.stickRadius*2) + 'px;background:#ff6ec7;border-radius:50%;transform:translate(-50%,-50%);"></div>';
  document.body.appendChild(joy);

  // Touch events
  joy.addEventListener('touchstart', function(e) {
    joystick.active = true;
    const t = e.touches[0];
    const rect = joy.getBoundingClientRect();
    joystick.startX = t.clientX - rect.left - joystick.radius;
    joystick.startY = t.clientY - rect.top - joystick.radius;
    joystick.dx = 0;
    joystick.dy = 0;
    e.preventDefault();
  });
  joy.addEventListener('touchmove', function(e) {
    if (!joystick.active) return;
    const t = e.touches[0];
    const rect = joy.getBoundingClientRect();
    let dx = t.clientX - rect.left - joystick.radius;
    let dy = t.clientY - rect.top - joystick.radius;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist > joystick.radius) {
      dx = dx * joystick.radius / dist;
      dy = dy * joystick.radius / dist;
    }
    joystick.dx = dx;
    joystick.dy = dy;
    // Move stick
    const stick = document.getElementById('stick');
    stick.style.left = (joystick.radius + dx) + 'px';
    stick.style.top = (joystick.radius + dy) + 'px';
    e.preventDefault();
  });
  joy.addEventListener('touchend', function(e) {
    joystick.active = false;
    joystick.dx = 0;
    joystick.dy = 0;
    // Reset stick
    const stick = document.getElementById('stick');
    stick.style.left = joystick.radius + 'px';
    stick.style.top = joystick.radius + 'px';
    e.preventDefault();
  });
} else {
  // Hide joystick on PC
  const style = document.createElement('style');
  style.innerHTML = '#joystick{display:none!important;}';
  document.head.appendChild(style);
}

function getCurrentLevel() {
  for (let i = levels.length - 1; i >= 0; i--) {
    if (score >= levels[i].score) return i;
  }
  return 0;
}

function spawnBall() {
  // AI ball aims at player from its spawn point with some randomness
  const radius = 15;
  const x = Math.random() * (canvas.width - radius * 2) + radius;
  const y = -radius; // start just above the canvas so it enters smoothly
  const angleToPlayer = Math.atan2(player.y - y, player.x - x);
  const angle = angleToPlayer + (Math.random() - 0.5) * 0.6; // slight randomness
  level = getCurrentLevel();
  const minSpeed = levels[level].speed[0];
  const maxSpeed = levels[level].speed[1];
  const speed = minSpeed + Math.random() * (maxSpeed - minSpeed);

  const ball = {
    x,
    y,
    radius,
    color: '#ff2e63',
    dx: speed * Math.cos(angle),
    dy: speed * Math.sin(angle)
  };

  // limit max balls to avoid overwhelming the game
  if (balls.length < 40) balls.push(ball);
}

function updatePlayer() {
  if (useJoystick) {
    // Joystick control
    if (joystick.active && (joystick.dx !== 0 || joystick.dy !== 0)) {
      const mag = Math.sqrt(joystick.dx*joystick.dx + joystick.dy*joystick.dy);
      if (mag > 5) {
        // Normalize
        const nx = joystick.dx / joystick.radius;
        const ny = joystick.dy / joystick.radius;
        // Move player
        let px = player.x + nx * player.speed;
        let py = player.y + ny * player.speed;
        // Clamp
        if (px - player.radius < 0) px = player.radius;
        if (px + player.radius > canvas.width) px = canvas.width - player.radius;
        if (py - player.radius < 0) py = player.radius;
        if (py + player.radius > canvas.height) py = canvas.height - player.radius;
        player.x = px;
        player.y = py;
      }
    }
  } else {
    // PC WASD
    if (keys['w'] && player.y - player.radius > 0) player.y -= player.speed;
    if (keys['s'] && player.y + player.radius < canvas.height) player.y += player.speed;
    if (keys['a'] && player.x - player.radius > 0) player.x -= player.speed;
    if (keys['d'] && player.x + player.radius < canvas.width) player.x += player.speed;
  }
}

function updateBalls() {
  for (let i = balls.length - 1; i >= 0; i--) {
    const b = balls[i];
    b.x += b.dx;
    b.y += b.dy;

    // Bounce off left/right walls and clamp position
    if (b.x - b.radius < 0) {
      b.x = b.radius;
      b.dx *= -1;
    } else if (b.x + b.radius > canvas.width) {
      b.x = canvas.width - b.radius;
      b.dx *= -1;
    }

    // Bounce off bottom and prevent getting stuck above the top
    if (b.y + b.radius > canvas.height) {
      b.y = canvas.height - b.radius;
      b.dy *= -1;
    }

    // Remove balls that somehow get far above the canvas (safety)
    if (b.y < -200 || b.y > canvas.height + 200) {
      balls.splice(i, 1);
    }
  }
}

function checkCollision(a, b) {
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  const distance = Math.sqrt(dx*dx + dy*dy);
  return distance < a.radius + b.radius;
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw level
  ctx.font = 'bold 24px Arial';
  ctx.fillStyle = '#ff6ec7';
  ctx.textAlign = 'center';
  ctx.fillText('Level: ' + levels[level].name, canvas.width/2, 40);

  // Draw player
  ctx.fillStyle = player.color;
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
  ctx.fill();

  // Draw balls
  balls.forEach(b => {
    ctx.fillStyle = b.color;
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.radius, 0, Math.PI*2);
    ctx.fill();
  });
}

function endGame() {
  gameRunning = false;
  document.getElementById('gameCanvas').style.display = 'none';
  document.getElementById('gameOver').style.display = 'block';
  document.getElementById('finalScore').textContent = `You Lose! Final Score: ${score}`;
}

document.getElementById('restartBtn').addEventListener('click', () => location.reload());

function gameLoop() {
  if(!gameRunning) return;

  frame++;
  updatePlayer();
  updateBalls();

  // Check collision with balls
  for(let b of balls) {
    if(checkCollision(player,b)) {
      endGame();
      return;
    }
  }

  // Spawn balls periodically
  if(frame % 120 === 0) spawnBall();

  draw();
  score++;
  document.getElementById('score').textContent = `Score: ${score}`;

  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
